<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FefinCall</title>
<style>
body { background:#111; color:white; font-family:Arial; margin:0; display:flex; flex-direction:column; align-items:center; }
h2 { margin-top:20px; }
#controls { margin: 15px; display:flex; gap:10px; }
#videos { display:flex; justify-content:center; margin-top:10px; gap:10px; }
video { width:45%; border-radius:10px; background:black; }
button { padding:10px 15px; border:none; border-radius:8px; cursor:pointer; }
#room { padding:10px; border-radius:8px; border:none; width:150px; }
#status { margin-top:10px; font-size:14px; color:#0a0; }
#controls button { background:#0a8400; color:white; }
#controls button.off { background:#a00; }
</style>
</head>
<body>

<h2>ðŸ“ž FefinCall WebRTC P2P</h2>

<div id="controls">
  <input id="room" placeholder="CÃ³digo de sala">
  <button onclick="startCall()">Iniciar</button>
  <button onclick="hangup()">Colgar</button>
  <button id="micBtn" onclick="toggleMic()">Mic On/Off</button>
  <button id="camBtn" onclick="toggleCam()">Cam On/Off</button>
</div>

<div id="videos">
  <video id="local" autoplay playsinline muted></video>
  <video id="remote" autoplay playsinline></video>
</div>

<div id="status">Status: Desconectado</div>

<script>
let pc, ws, localStream;
let micEnabled = true, camEnabled = true;

function randomRoom() {
  return "fefin_call" + Math.floor(1000 + Math.random()*9000);
}

async function startCall() {
  const roomInput = document.getElementById("room");
  if(!roomInput.value) roomInput.value = randomRoom();
  const room = roomInput.value;

  document.getElementById("status").innerText = "Status: Conectando...";

  ws = new WebSocket("wss://fefin-calls.fefin.workers.dev/?room=" + room);
  ws.onmessage = e => handleSignal(JSON.parse(e.data));
  ws.onopen = () => document.getElementById("status").innerText = "Status: Conectado a sala " + room;

  pc = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });

  pc.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({ candidate:e.candidate })); };
  pc.ontrack = e => document.getElementById("remote").srcObject = e.streams[0];

  localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
  document.getElementById("local").srcObject = localStream;
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ offer }));
}

function send(msg) { if(ws) ws.send(JSON.stringify(msg)); }

async function handleSignal(msg) {
  if(msg.offer){
    await pc.setRemoteDescription(msg.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    send({ answer });
  }
  if(msg.answer) await pc.setRemoteDescription(msg.answer);
  if(msg.candidate) pc.addIceCandidate(msg.candidate);
}

function hangup() {
  if(pc) pc.close();
  pc = null;
  if(ws) ws.close();
  ws = null;
  if(localStream){
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
  document.getElementById("status").innerText = "Status: Desconectado";
}

function toggleMic() {
  if(!localStream) return;
  micEnabled = !micEnabled;
  localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
  document.getElementById("micBtn").classList.toggle("off", !micEnabled);
}

function toggleCam() {
  if(!localStream) return;
  camEnabled = !camEnabled;
  localStream.getVideoTracks().forEach(t => t.enabled = camEnabled);
  document.getElementById("camBtn").classList.toggle("off", !camEnabled);
}
</script>

</body>
</html>
