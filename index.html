<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fefin Calls</title>
<style>
    body {
        margin: 0;
        background: #111;
        font-family: Arial;
        display: flex;
        height: 100vh;
        color: white;
    }

    #sidebar {
        width: 30%;
        background: #1c1c1c;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
    }

    #header {
        background: #075E54;
        padding: 15px;
        font-size: 20px;
        font-weight: bold;
    }

    #users {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .user {
        background: #222;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
    }

    #main {
        flex: 1;
        padding: 20px;
    }

    input, textarea {
        width: 100%;
        background: #222;
        border: 1px solid #444;
        color: white;
        padding: 10px;
        border-radius: 6px;
        margin-top: 10px;
    }

    button {
        padding: 10px;
        background: #25D366;
        border: none;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 18px;
        cursor: pointer;
    }

</style>
</head>
<body>

<div id="sidebar">
    <div id="header">Fefin Calls</div>
    <div id="users">Cargando usuarios…</div>
</div>

<div id="main">
    <h2>Crear llamada</h2>

    <input id="username" placeholder="Tu nombre">
    <button onclick="registerUser()">Registrar</button>

    <button onclick="createCall()">Crear llamada</button>
    <input id="callCode" placeholder="Código de llamada" readonly>

    <h2>Unirse a una llamada</h2>
    <input id="joinCode" placeholder="Código de llamada…">
    <button onclick="joinCall()">Unirse</button>

    <h2>Offer / Answer</h2>
    <button onclick="createOffer()">Generar Offer</button>
    <textarea id="offerBox"></textarea>

    <textarea id="answerBox" placeholder="Pega aquí el ANSWER"></textarea>
    <button onclick="applyAnswer()">Aplicar Answer</button>
</div>

<script>
const REPO = "TU_USUARIO/TU_REPO";
const RAW = "https://raw.githubusercontent.com/" + REPO + "/main/calls.json";

let pc = new RTCPeerConnection();

async function loadDB() {
    let res = await fetch(RAW + "?cache=" + Math.random());
    return await res.json();
}

async function updateDB(db) {
    await fetch("https://api.github.com/repos/" + REPO + "/contents/calls.json", {
        method: "PUT",
        headers: {
            "Authorization": "Bearer TU_TOKEN",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message: "update calls",
            content: btoa(JSON.stringify(db, null, 2)),
            sha: window.lastSha
        })
    });
}

async function registerUser() {
    let name = document.getElementById("username").value;
    let db = await loadDB();

    db.users[name] = { online: true };

    await updateDB(db);
    loadUsers();
}

async function loadUsers() {
    let db = await loadDB();
    let html = "";

    for (let u in db.users) {
        html += `<div class='user'>${u}</div>`;
    }

    document.getElementById("users").innerHTML = html;
}

async function createCall() {
    let name = document.getElementById("username").value;
    let id = Math.floor(Math.random() * 9000 + 1000);

    let code = `${name}_call${id}`;
    document.getElementById("callCode").value = code;

    let db = await loadDB();
    db.calls[code] = { offer: "", answer: "" };
    await updateDB(db);
}

async function joinCall() {
    let code = document.getElementById("joinCode").value;
    document.getElementById("callCode").value = code;
}

async function createOffer() {
    pc.onicecandidate = () => {
        offerBox.value = JSON.stringify(pc.localDescription);
    };

    let offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    let db = await loadDB();
    db.calls[document.getElementById("callCode").value].offer = offerBox.value;
    await updateDB(db);
}

async function applyAnswer() {
    let ans = JSON.parse(answerBox.value);
    await pc.setRemoteDescription(ans);

    let db = await loadDB();
    db.calls[document.getElementById("callCode").value].answer =
        answerBox.value;

    await updateDB(db);

    alert("Answer aplicado");
}

loadUsers();
setInterval(loadUsers, 5000);
</script>

</body>
</html>
